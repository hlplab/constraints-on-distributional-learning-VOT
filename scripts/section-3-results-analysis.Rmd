```{r load-libraries}
require(tidyverse)
require(magrittr)

require(brms)
require(MVBeliefUpdatr)
require(phonR)
require(rsample)

source("functions.R")
```

## Results

### Research questions and hypotheses

 1. Do listeners change their categorization behaviour in the direction predicted by their respective exposure distributions? 
 2. At what stage in the experiment did the behavioural change first emerge?
 3. Are the shifts in categorisation behaviour proportional to the differences between the exposure conditions?
 4. Do the differences between exposure conditions diminish with repeated testing and without intermittent exposure?

[MORE HERE]

### Regression analyses
Figures \@ref(fig:plot-fit-slope-PSE)A-B summarize participantsâ€™ categorisation responses during exposure and test blocks, depending on the exposure condition and VOT. We analyzed participants' categorisation responses during exposure and test blocks in two separate Bayesian mixed-effects psychometric models, fit using brms [@R-brms_a] in R [@R; @RStudio, for details, see SI, \@ref(sec:analysis-approach)]. These models account for attentional lapses while estimating participants' categorisation functions. Failing to account for attentional lapses---while commonplace in research on speech perception [but see @clayards2008perception; @kleinschmidt2016you]---can lead to biased estimates of categorization boundaries [@prins2012psychometric; @wichmann2001psychometric]. For the present experiment, however, lapse rates were negligible (`r make_CI(fit_mix_test, "theta1_Intercept")`), and all results replicate in simple mixed-effects logistic regressions [@jaeger2008categorical]. 

Here we focus on the model fit to the test blocks, which were identical within and across exposure conditions. Analyses of the exposure blocks are reported in the SI (\@ref(sec:exposure-analyses)), and replicate all effects found in the test blocks. Tables \@ref(tab:XXX)-\@ref(tab:XXX) present Bayesian hypothesis tests that assess our hypotheses. As shown in Table \@ref(tab:XXX) 

```{r model-fit-test-blocks, include=FALSE}
# Storing some information about the data set submitted for analysis 
# (to facilitating unscaling predictions back into the original scales for plotting)
d.mean_sd_scaling <- 
  d_for_analysis %>% 
  group_by(Phase) %>% 
  filter(Item.Labeled == FALSE) %>% 
  summarise(across(Item.VOT, list(mean = mean, sd = sd)))

VOT.mean_exposure <- (d.mean_sd_scaling %>% pull(Item.VOT_mean))[1]
VOT.sd_exposure <- (d.mean_sd_scaling %>% pull(Item.VOT_sd))[1]
VOT.mean_test <- (d.mean_sd_scaling %>% pull(Item.VOT_mean))[2]
VOT.sd_test <- (d.mean_sd_scaling %>% pull(Item.VOT_sd))[2]

levels_Condition.Exposure = c("Shift0", "Shift10", "Shift40")
contrast_type <- "difference"

my_priors <- c(
  prior(student_t(3, 0, 2.5), class = "b", dpar = "mu2"),
  prior(student_t(3, 0, 2.5), class = "b", dpar = "theta1"),
  prior(cauchy(0, 2.5), class = "sd"),
  prior(lkj(1), class = "cor"))

# Simplifying model with uniform bias
fit_mix_test <- 
  brm(
  bf(
    Response.Voiceless ~ 1,
    mu1 ~ 0 + offset(0),
    mu2 ~ 1 + VOT_gs * Condition.Exposure * Block + 
      (1 + VOT_gs * Block | ParticipantID) + 
      (1 + VOT_gs * Condition.Exposure * Block | Item.MinimalPair),
    theta1 ~ 1),
  data = d_for_analysis %>% 
    filter(Phase == "test") %>% 
    prepVars(levels.Condition = levels_Condition.Exposure, contrast_type = contrast_type),
  cores = 4,
  chains = chains,
  init = 0,
  iter = 4000, 
  warmup = 2000, 
  family = mixture(bernoulli("logit"), bernoulli("logit"), order = F),
  control = list(adapt_delta = .99),
  file = "../models/Exp-AE-DLVOT-labelled-lapsing-GLMM-difference-no-RTexcl.rds")

# fit difference coded model on exposure block
fit_mix_exposure <- 
  update(
    fit_mix_test,
    newdata = d_for_analysis %>% 
      filter(Phase == "exposure" & Item.Labeled == FALSE) %>% 
      prepVars(levels.Condition = levels_Condition.Exposure, contrast_type = contrast_type),
    file = "../models/Exp-AE-DLVOT-lapsing-differencecoded-exposureblocks.rds")
```

```{r fit-nested-models-for-intercepts-slopes-plot, warning=FALSE, message=FALSE}
# Refit the same model, formulated as nesting intercepts and slopes within each unique combination of 
# exposure condition and block. This makes it easier to extract the intercept, slope, and PSE for the
# large result figure (Panels C and D).
fit_mix_test_nested <- 
  brm(
    bf(
      Response.Voiceless ~ 1,
      mu1 ~ 0 + offset(0),
      mu2 ~  0 + I(paste(Condition.Exposure, Block, sep = "x")) / VOT_gs + 
        (0 + Block / VOT_gs | ParticipantID) + 
        (0 + I(paste(Condition.Exposure, Block, sep = "x")) / VOT_gs | Item.MinimalPair),
      theta1 ~ 1),
    data = d_for_analysis %>% 
      filter(Phase == "test") %>% 
      prepVars(levels.Condition = levels_Condition.Exposure, constrast_type = "difference"),
    cores = chains,
    chains = chains,
    init = 0,
    iter = 4000, # iterations to run
    warmup = 2000, # samples used to fit
    family = mixture(bernoulli("logit"), bernoulli("logit"), order = F),
    control = list(adapt_delta = .99),
    file = "../models/Exp-AE-DLVOT-lapsing-nested-test.rds")

fit_mix_exposure_nested <- 
  update(
    fit_mix_test_nested,
    newdata = d_for_analysis %>% 
      filter(Phase == "exposure") %>% 
      prepVars(levels.Condition = levels_Condition.Exposure, contrast_type = "difference"),
    file = "../models/Exp-AE-DLVOT-lapsing-nested-exposure.rds")

# Extract intercepts and slopes from test and exposure model
get_intercepts_and_slopes <- 
  . %>%
  gather_draws(`b_mu2_IpasteCondition.ExposureBlocksepEQ.*`, regex = TRUE, ndraws = 8000) %>% 
  mutate(.variable = gsub("b_mu2_IpasteCondition.ExposureBlocksepEQxShift(\\d{1,2})x(\\d{1}.*$)", "Shift\\1.\\2", .variable),
         term = ifelse(str_detect(.variable, "VOT_gs"), "slope", "Intercept")) %>% 
  separate(col = .variable, into = c("Condition.Exposure", "Block"), sep = "\\.") %>% 
  mutate(Block = ifelse(str_detect(Block, "VOT"), str_replace(Block, "(\\d{1}):VOT_gs", "\\1"), Block)) %>% 
  pivot_wider(names_from = term, values_from = ".value") %>% 
  relocate(c(Condition.Exposure, Block, Intercept, slope, .chain, .iteration, .draw))

d.estimates <- 
  full_join(
    fit_mix_test_nested %>% get_intercepts_and_slopes(),
    fit_mix_exposure_nested %>% get_intercepts_and_slopes()) %>%
  mutate(
    PSE = ifelse(
      Block %in% c(2, 4, 6), 
      descale(-Intercept/slope, VOT.mean_exposure, VOT.sd_exposure), 
      descale(-Intercept/slope, VOT.mean_test, VOT.sd_test))) %>% 
  group_by(Condition.Exposure, Block) %>% 
  summarise(
    across(
      c(Intercept, slope, PSE), 
      list(lower = ~ quantile(.x, probs = .025), mean = mean, upper = ~ quantile(.x, probs = .975))))
```

```{r predictions-exposure-conditions-by-IOs, warning=FALSE}
# get the actual means and variances of the exposure stimuli by category and condition
d.summarystats_exposure <- 
  d_for_analysis %>% 
  filter(Phase == "exposure") %>% 
  mutate(Category = ifelse(Item.ExpectedResponse.Voicing == "voiced", "/d/", "/t/")) %>% 
  group_by(Condition.Exposure, Category) %>% 
  # get all exposure rows from one participant per condition
  slice_head(n = 144) %>% 
  summarise(mean = mean(Item.VOT, na.rm = T),
            var = var(Item.VOT, na.rm = T))

exposure_shift0_mean_d <- (d.summarystats_exposure %>% pull(mean))[1]
exposure_shift0_mean_t <- (d.summarystats_exposure %>% pull(mean))[2]
exposure_shift10_mean_d <- (d.summarystats_exposure %>% pull(mean))[3]
exposure_shift10_mean_t <- (d.summarystats_exposure %>% pull(mean))[4]
exposure_shift40_mean_d <- (d.summarystats_exposure %>% pull(mean))[5]
exposure_shift40_mean_t <- (d.summarystats_exposure %>% pull(mean))[6]

exposure_var_d <- (d.summarystats_exposure %>% pull(var))[1]
exposure_var_t <- (d.summarystats_exposure %>% pull(var))[2] 

x <- 
  d_for_analysis %>% 
  filter(Phase == "test") %>% 
  distinct(Item.VOT) %>%
  pull()

conditions <- tibble(
  condition = c("shift0", "shift10", "shift40")) 
  
ios <- 
  tibble(
    category = factor(c("/d/", "/t/")),
    Sigma = list(matrix(sqrt(exposure_var_d)), matrix(sqrt(exposure_var_t))),
    prior = c(.5, .5),
    lapse_rate = c(0, 0),
    lapse_bias = c(.5, .5),
    Sigma_noise = list(matrix(80), matrix(80)))

io.conditions <- 
  crossing(conditions, ios) %>% 
  cbind(tibble(mu = list(c(VOT = exposure_shift0_mean_d), c(VOT = exposure_shift0_mean_t), c(VOT = exposure_shift10_mean_d), c(VOT = exposure_shift10_mean_t), c(VOT = exposure_shift40_mean_d), c(VOT = exposure_shift40_mean_t)))) %>% 
  relocate(c(condition, category, mu)) %>% 
  nest(io = -c(condition)) %>% 
  crossing(x) %>% 
  mutate(x = map(x, ~ c(.x))) %>% 
  nest(x = x)

d.io.categorisation <- 
  io.conditions %>% 
  mutate(categorisation = 
           map2(x, io,
          ~ get_categorization_from_MVG_ideal_observer(x = .x$x, model = .y, decision_rule = "proportional") %>% 
            mutate(VOT = map(x, ~ .x[1]) %>% unlist()))) %>%
  unnest(cols = categorisation, names_repair = "unique") %>% 
  select(c(condition, io, category, response, VOT)) %>% 
  pivot_wider(names_from = category, values_from = response, names_prefix = "response_") %>% 
  mutate(n_d = round(`response_/d/` * 10^9),
         n_t = 10^9 - n_d)

d.io.categorisation %<>%
  group_by(condition) %>% 
  nest() %>% 
  mutate(model_unscaled = map(data, ~ glm(cbind(n_t, n_d) ~ 1 + VOT, family = binomial, data = .x)),
         intercept_unscaled = map_dbl(model_unscaled, ~ tidy(.x)[1,2] %>% pull()),
         slope_unscaled = map_dbl(model_unscaled, ~ tidy(.x)[2,2] %>% pull()), 
         model_scaled = map(data, ~ glm(cbind(n_t, n_d) ~ 1 + I((VOT - VOT.mean_test)/ (2 * VOT.sd_test)), family = binomial, data = .x)),
         intercept_scaled = map_dbl(model_scaled, ~ tidy(.x)[1,2] %>% pull()),
         slope_scaled = map_dbl(model_scaled, ~ tidy(.x)[2,2] %>% pull()),
           PSE = -intercept_unscaled/slope_unscaled)
```

```{r prepare-plot-intercepts-slopes}
p.intercept <- 
  d.estimates %>% 
  ggplot(aes(x = Block, y = Intercept_mean, colour = Condition.Exposure, group = Condition.Exposure)) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 0.75, xmax = 1.25), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 2.75, xmax = 3.25), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 4.75, xmax = 5.25), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 6.75, xmax = 7.25), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 7.75, xmax = 8.25), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 8.75, xmax = 9.25), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_point(position = position_dodge(.3), size = 1) +
  geom_linerange(aes(ymin = Intercept_lower, ymax = Intercept_upper), linewidth = .6, position = position_dodge(.3), alpha = .5) +
  stat_summary(geom = "line", position = position_dodge(.3)) + 
  geom_hline(yintercept = d.io.categorisation[[7]][1], linetype = 2, linewidth = 0.8, colour = "#cc0000", alpha = 0.5) +
  geom_hline(yintercept = d.io.categorisation[[7]][2], linetype = 2, linewidth = .8, colour = "#12D432", alpha = 0.5) +
  geom_hline(yintercept = d.io.categorisation[[7]][3], linetype = 2, linewidth = .8, colour = "#0481F3", alpha = 0.5) +
  scale_colour_manual("Condition",
    labels = c("+0ms", "+10ms", "+40ms"),
    values = c("#cc0000", "#12D432","#0481F3"),
    aesthetics = "color") +
  scale_y_continuous("Mean Intercept") +
  scale_x_discrete("Block", labels = c("1" = "Test 1", "2" = "Exposure 1", "3" = "Test 2", "4" = "Exposure 2", "5" = "Test 3", "6" = "Exposure 3", "7" = "Test 4", "8" = "Test 5", "9" = "Test 6")) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 22.5, hjust = 1))

p.slope_1to7 <- 
  d.estimates %>% 
  ggplot(aes(x = Block, y = slope_mean, 
             colour = Condition.Exposure, 
             group = Condition.Exposure)) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 0.55, xmax = 1.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 2.55, xmax = 3.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 4.55, xmax = 5.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
   geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 6.55, xmax = 7.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
   geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 7.55, xmax = 8.45),
            fill = "grey",
            alpha = .009,
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 8.55, xmax = 9.45),
            fill = "grey",
            alpha = .009,
            inherit.aes = F) +
  geom_point(position = position_dodge(.3), size = 1) +
  geom_linerange(aes(ymin = slope_lower, ymax = slope_upper), linewidth = .6, position = position_dodge(.3), alpha = .5) +
  stat_summary(geom = "line", position = position_dodge(.3)) +
  geom_hline(yintercept = 23, linetype = 2, linewidth = 0.8, colour = "#cc0000", alpha = 0.5) +
  geom_hline(yintercept = 23, linetype = 2, linewidth = .8, colour = "#12D432", alpha = 0.5) +
  geom_hline(yintercept = 23, linetype = 2, linewidth = .8, colour = "#0481F3", alpha = 0.5) +
  scale_colour_manual("Condition",
    labels = c("+0ms", "+10ms", "+40ms"),
    values = c("#cc0000", "#12D432","#0481F3"),
    aesthetics = "color") +
  scale_y_continuous("Mean Slope") +
  scale_x_discrete("Block", labels = c("1" = "Test 1", "2" = "Exposure 1", "3" = "Test 2", "4" = "Exposure 2", "5" = "Test 3", "6" = "Exposure 3", "7" = "Test 4", "8" = "Test 5", "9" = "Test 6")) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 22.5, hjust = 1))

p.PSE_1to7 <-d.estimates %>% 
  ggplot(aes(x = Block, y = PSE_mean, colour = Condition.Exposure, group = Condition.Exposure)) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 0.55, xmax = 1.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 2.55, xmax = 3.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 4.55, xmax = 5.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
   geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 6.55, xmax = 7.45), 
            fill = "grey", 
            alpha = .009, 
            inherit.aes = F) +
   geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 7.55, xmax = 8.45),
            fill = "grey",
            alpha = .009,
            inherit.aes = F) +
  geom_rect(aes(ymin = -Inf, ymax = Inf, xmin = 8.55, xmax = 9.45),
            fill = "grey",
            alpha = .009,
            inherit.aes = F) +
  geom_point(position = position_dodge(.3), size = 1) +
  geom_linerange(aes(ymin = PSE_lower, ymax = PSE_upper), linewidth = .6, position = position_dodge(.3), alpha = .5) +
  stat_summary(geom = "line", position = position_dodge(.3)) +
  geom_hline(yintercept = d.io.categorisation[[9]][1], linetype = 2, linewidth = 0.8, colour = "#cc0000", alpha = 0.5) +
  geom_hline(yintercept = d.io.categorisation[[9]][2], linetype = 2, linewidth = .8, colour = "#12D432", alpha = 0.5) +
  geom_hline(yintercept = d.io.categorisation[[9]][3], linetype = 2, linewidth = .8, colour = "#0481F3", alpha = 0.5) +
  scale_colour_manual("Condition",
    labels = c("+0ms", "+10ms", "+40ms"),
    values = c("#cc0000", "#12D432","#0481F3"),
    aesthetics = "color") +
  scale_y_continuous("Mean PSE") +
  scale_x_discrete("Block", labels = c("1" = "Test 1", "2" = "Exposure 1", "3" = "Test 2", "4" = "Exposure 2", "5" = "Test 3", "6" = "Exposure 3", "7" = "Test 4", "8" = "Test 5", "9" = "Test 6")) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 22.5, hjust = 1))

p.params_1to7 <- (p.slope_1to7 | p.PSE_1to7) + 
  plot_layout(guides = "collect") &
  theme(legend.position = "none", axis.text = element_text(size = 8))
```

```{r plot-test-exposure-fit, fig.width=11, fig.height=3}
get_conditional_effects <- function(model, data, phase) 
  conditional_effects(
    x = model,
    effects = "VOT_gs:Condition.Exposure",
    conditions = make_conditions(
      data %>% 
        filter(Phase == .env$phase & Item.Labeled == FALSE) %>% 
        prepVars(levels.Condition = levels_Condition.Exposure, contrast_type = "difference"), 
      vars = c("Block")),
    method = "posterior_epred",
    ndraws = 500,
    re_formula = NA)

cond_fit_test_exposure <- 
  tibble(
    full_join(
      get_conditional_effects(fit_mix_exposure, d_for_analysis, "exposure") %>%
        .[[1]] %>% 
        mutate(Item.VOT = descale(VOT_gs, VOT.mean_exposure, VOT.sd_exposure)), 
      get_conditional_effects(fit_mix_test, d_for_analysis, "test") %>%
        .[[1]] %>% 
        mutate(Item.VOT = descale(VOT_gs, VOT.mean_test, VOT.sd_test)))) %>% 
  arrange(as.numeric(as.character(Block))) %>% 
  mutate(
    Phase = ifelse(Block %in% c(1, 3, 5, 7, 8, 9), "test", "exposure"),
    Condition.Exposure = case_when(
    Condition.Exposure == "Shift0" ~ "+0ms",
    Condition.Exposure == "Shift10" ~ "+10ms",
    Condition.Exposure == "Shift40" ~ "+40ms"),
    Block = factor(case_when(
      Block == 1 ~ "Test 1",
      Block == 3 ~ "Test 2",
      Block == 5 ~ "Test 3",
      Block == 7 ~ "Test 4",
      Block == 8 ~ "Test 5",
      Block == 9 ~ "Test 6",
      Block == 2 ~ "Exposure 1",
      Block == 4 ~ "Exposure 2",
      Block == 6 ~ "Exposure 3")), 
    Block = fct_relevel(Block, c("Test 1", "Exposure 1", "Test 2", "Exposure 2", "Test 3", "Exposure 3",  "Test 4", "Test 5", "Test 6"))) 

label_colour <- tibble(
  Block = c("Test 1", "Exposure 1", "Test 2", "Exposure 2", "Test 3", "Exposure 3", "Test 4"), 
  Block.colour = c("grey", "black", "grey", "black", "grey", "black", "grey")) %>% 
  mutate(Block = factor(Block, levels = Block, ordered = T))

p.fit_1to7 <- cond_fit_test_exposure %>% 
  filter(Block %in% c("Test 1", "Exposure 1", "Test 2", "Exposure 2", "Test 3", "Exposure 3", "Test 4")) %>% 
  ggplot() +
  geom_rect(
    data = label_colour,
    aes(xmin = -Inf, xmax = Inf,
        ymin = 1.05, ymax = 1.3,
        fill = Block.colour), show.legend = F) +
  scale_fill_manual(values = c("grey" = "grey", "black" = "white")) +
  new_scale_fill() +
  geom_ribbon(aes(
    x = Item.VOT, 
    y = estimate__, 
    group = Condition.Exposure,
    ymin = lower__, ymax = upper__, fill = Condition.Exposure), alpha = .1) +
  geom_line(aes(
    x = Item.VOT, 
    y = estimate__, 
    group = Condition.Exposure,
    color = Condition.Exposure), 
    size = .7,
    alpha = 0.6) +
  geom_rug(data = d_for_analysis %>%
             group_by(Phase, Block) %>%
             filter(Block %in% c(1:7)) %>% 
             mutate(
               Block = factor(case_when(
                 Block == 1 ~ "Test 1",
                 Block == 3 ~ "Test 2",
                 Block == 5 ~ "Test 3",
                 Block == 7 ~ "Test 4",
                 Block == 2 ~ "Exposure 1",
                 Block == 4 ~ "Exposure 2",
                 Block == 6 ~ "Exposure 3")),
               Block = fct_relevel(Block, c("Test 1", "Exposure 1", "Test 2", "Exposure 2", "Test 3", "Exposure 3",  "Test 4"))) %>%
             distinct(Item.VOT),
           aes(x = Item.VOT),
           alpha = 0.5,
           colour = "grey",
           inherit.aes = F) +
  stat_summary(
    data = d_for_analysis %>%
      filter(Block %in% c(1:7), Item.Labeled == FALSE) %>%
      mutate(
        Condition.Exposure = case_when(
          Condition.Exposure == "Shift0" ~ "+0ms",
          Condition.Exposure == "Shift10" ~ "+10ms",
          Condition.Exposure == "Shift40" ~ "+40ms"),
        Block = factor(case_when(
          Block == 1 ~ "Test 1",
          Block == 2 ~ "Exposure 1",
          Block == 3 ~ "Test 2",
          Block == 4 ~ "Exposure 2",
          Block == 5 ~ "Test 3",
          Block == 6 ~ "Exposure 3",
          Block == 7 ~ "Test 4"))) %>%
      group_by(Condition.Exposure, Block),
    fun.data = mean_cl_boot,
    mapping = aes(x = Item.VOT,
                  y = Response.Voiceless,
                  colour = Condition.Exposure),
    geom = "pointrange",
    size = 0.1,
    alpha = 0.7,
    position = position_dodge2(width = 2),
    inherit.aes = F) +
  scale_x_continuous("VOT (msec)") +
  scale_y_continuous("Proportion \"t\"-responses") +
  scale_color_manual(
    "Condition",
    labels = c("+0ms", "+10ms", "+40ms"),
    values = c("#cc0000", "#12D432","#0481F3"),
    aesthetics = c("color", "fill")) +
  coord_cartesian(clip="off", ylim=c(0, 1)) +
  facet_grid(~ Block, scales = "free_x", space = "free_x") + 
  theme(legend.position = "top",
        legend.justification = "right",
        strip.background = element_rect(fill = NA),
        strip.text.x.top = element_text(colour = "black"))

p.fit_7to9 <- cond_fit_test_exposure %>% 
  filter(Block %in% c("Test 4", "Test 5", "Test 6")) %>% 
  ggplot() +
  geom_ribbon(aes(
    x = Item.VOT, 
    y = estimate__, 
    group = Condition.Exposure,
    ymin = lower__, ymax = upper__, fill = Condition.Exposure), alpha = .1) +
  geom_line(aes(
    x = Item.VOT, 
    y = estimate__, 
    group = Condition.Exposure,
    color = Condition.Exposure), 
    size = .7,
    alpha = 0.6) +
geom_rug(data = d_for_analysis %>%
             group_by(Phase, Block) %>%
             filter(Block %in% c(7:9)) %>% 
             mutate(
               Block = factor(case_when(
                 Block == 7 ~ "Test 4",
                 Block == 8 ~ "Test 5",
                 Block == 9 ~ "Test 6")),
               Block = fct_relevel(Block, c("Test 4", "Test 5", "Test 6"))) %>%
             distinct(Item.VOT),
           aes(x = Item.VOT),
           alpha = 0.5,
           colour = "grey",
           inherit.aes = F) +
  stat_summary(
    data = d_for_analysis %>%
      filter(Block %in% c(7:9), Item.Labeled == FALSE) %>%
      mutate(
        Condition.Exposure = case_when(
          Condition.Exposure == "Shift0" ~ "+0ms",
          Condition.Exposure == "Shift10" ~ "+10ms",
          Condition.Exposure == "Shift40" ~ "+40ms"),
        Block = factor(case_when(
          Block == 7 ~ "Test 4",
          Block == 8 ~ "Test 5",
          Block == 9 ~ "Test 6"))) %>%
      group_by(Condition.Exposure, Block),
    fun.data = mean_cl_boot,
    mapping = aes(x = Item.VOT,
                  y = Response.Voiceless,
                  colour = Condition.Exposure),
    geom = "pointrange",
    size = 0.1,
    alpha = 0.7,
    position = position_dodge2(width = 2),
    inherit.aes = F) +
  scale_x_continuous("VOT (msec)") +
  scale_y_continuous("Proportion \"t\"-responses") +
  scale_color_manual(
    "Condition",
    labels = c("+0ms", "+10ms", "+40ms"),
    values = c("#cc0000", "#12D432","#0481F3"),
    aesthetics = c("color", "fill")) +
  facet_wrap(. ~ Block, nrow = 1) + 
  theme(legend.position = "none",
        legend.justification = "right",
        axis.title.y = element_blank(),
        strip.background = element_rect(fill = "grey"),
        strip.text.x = element_text(colour = "black"))
```

(ref:plot-fit-slope-PSE) Summary of results. **Panel A:** Changes in listeners psychometric categorisation functions as a function of exposure, from Test 1 to Test 4 with all intervening exposure blocks. Point ranges indicate the mean proportion of "t"-responses and their 95% bootstrapped CI. Lines and shaded intervals show the MAP predictions and 95% posterior CIs of a Bayesian mixed-effects psychometric model fit to participants' responses. **Panel B:** Same as Panel A but for the final three test blocks without intervening exposure. Test 4 is shown as part of both Panels A and B. **Panels C \& D:** Changes across blocks in the slope and boundary (point-of-subjective-equality, PSE) of the categorisation functions shown in Panels A-B. Point ranges represent the posterior means and their 95% CI. Dashed reference lines show the intercepts and PSEs that naive (non-rational) learner would be expected to converge against after sufficient exposure (an ideal observer model that knows the exposure distributions). 

\begin{landscape}
```{r plot-fit-slope-PSE, fig.width=12.5, fig.height=8, warning=FALSE, fig.cap="(ref:plot-fit-slope-PSE)"}
p.fit_1to7 + p.fit_7to9 + p.params_1to7 +
  plot_annotation(tag_levels = 'A') +
  plot_layout(
    design = "
AAAAAAAAA
######BBB
CCCCCCCCC
",
heights = c(1, 1, 2))
```
\end{landscape}




```{r}
fixed_eff_exp2 <- tidy(fit_mix_test, effects = "fixed") %>% 
  select(-c(effect, component))

# load helmert contrast-coded model
fit_mix_helmert <- read_rds("../models/Exp-AE-DLVOT-labelled-lapsing-GLMM-helmert-no-RTexcl.rds")

fixed_eff_exp2_helmert <- tidy(fit_mix_helmert, effects = "fixed") %>% 
  select(-c(effect, component))

# kable(fixed_eff_exp2, booktabs = TRUE) %>% 
#   kable_styling(latex_options = c("striped", "repeat_header", "scale_down"), position = "center") 


# get hypotheses of fixed effects
hypotheses <- hypothesis(fit_mix_test, paste(rownames(fixef(fit_mix_test))[-c(1, 2, 3)], "< 0"))
table <- hypotheses$hypothesis %>% select(-Star)
```






## Description of the overall pattern of results (main effects)

- The overall lapse rate was negligible ($\hat{\beta} =$ `r make_CI(fit_mix_test, "theta1_Intercept ", "theta1_Intercept < 0")`) indicating that participants were paying attention in the majority of trials. 
- There was a main effect of VOT ($\hat{\beta} =$ `r get_CI(fit_mix_test, "mu2_VOT_gs", "mu2_VOT_gs > 0")`): participants were more likely to respond "t" as VOT increased. 
- Condition had a main effect on responses such that with larger shifts away from the baseline, participants responded with fewer "t"s.  
- Comparing the +10ms condition with the baseline condition across all blocks: there was a reduction in log-odds of responding "t" in the +10ms condition compared to the baseline condition ($\hat{\beta} =$ `r  get_CI(fit_mix_test, "mu2_Condition.Exposure_Shift10vs.Shift0", "mu2_Condition.Exposure_Shift10vs.Shift0 < 0")`).
- Comparing the +40ms against the +10ms condition across all blocks: there was a reduction in log-odds of responding "t" in the +40ms condition compared to the +10ms condition ($\hat{\beta} =$ `r  get_CI(fit_mix_test, "mu2_Condition.Exposure_Shift40vs.Shift10", "mu2_Condition.Exposure_Shift40vs.Shift10 < 0")`).
- Tellingly, the reduction in log-odds was larger in the +40 vs +10ms comparison, reflecting the larger magnitude of shift from the baseline (`r get_bf(fit_mix_test, "mu2_Condition.Exposure_Shift40vs.Shift10 < mu2_Condition.Exposure_Shift10vs.Shift0 ")`).

### Interactions
The interactions provide between block comparisons of the differences between conditions. We focus on the first 4 test blocks as they were interspersed with exposure. In order to examine the effects of exposure condition on behaviour within block, and how each condition changed by block (simple effects of condition and block) we fitted 2 nested models that embed condition within block, and block within condition. We report the interactions in conjunction with the simple effects. 

- Comparing the change in differences between +10ms and baseline between blocks: we see an overall reduction in the log-odds of responding "t" between test blocks 1 and 4 however almost all that reduction took place between test blocks 1 and 2 ($\hat{\beta} =$ `r get_CI(fit_mix_test, "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test2vs.Test1", "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test2vs.Test1 < 0")`). Between test blocks 2 and 4, differences in behaviour between the two groups did not change significantly in spite of increased input from the exposure blocks. 
- Comparing the change in differences between +40ms and +10ms between blocks: 
  -There was a consistent reduction in log-offs of responding "t" from blocks 1 through 4, indicating an incremental shift in categorisation towards the right as participants received more input. The biggest change was observed between test block 1 and 2 ($\hat{\beta} =$ `r get_CI(fit_mix_test, "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test2vs.Test1", "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test2vs.Test1 < 0")`). 
  - The difference between condition +40 and +10 continued to widen after the second exposure block,  ($\hat{\beta} =$ `r get_CI(fit_mix_test, "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test3vs.Test2", "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test3vs.Test2 < 0")`) but not much incremental shift was observed in the 4th test block in spite of full exposure to the 144 trials at this stage ($\hat{\beta} =$ `r get_CI(fit_mix_test, "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test4vs.Test3", "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test4vs.Test3 < 0")`)



```{r fit-nested-blocks-simple-effects, results='hide'}
# nested model to get simple effects of Condition embedded in block
fit_mix_test_nested_block <- brm(
   bf(
     Response.Voiceless ~ 1,
     mu1 ~ 0 + offset(0),
     mu2 ~ 0 + Block / (Condition.Exposure * VOT_gs) +
       (0 + Block / VOT_gs | ParticipantID) +
       (0 + Block / (Condition.Exposure * VOT_gs) | Item.MinimalPair),
     theta1 ~ 1),
   data = d_for_analysis %>%
     filter(Phase == "test") %>%
     prepVars(levels.Condition = levels_Condition.Exposure, contrast_type = "difference"),
   cores = 4,
   chains = chains,
   init = 0,
   iter = 4000, # if 1000 warmup then iter can be lowered to 2000
   warmup = 2000, # 1000 warmup will exceed max tree depth
   family = mixture(bernoulli("logit"), bernoulli("logit"), order = F),
   control = list(adapt_delta = .99),
   file ="../models/Exp-AE-DLVOT-nested-block-condVOT.rds")

fit_mix_test_nested_condition <- brm(
   bf(
     Response.Voiceless ~ 1,
     mu1 ~ 0 + offset(0),
     mu2 ~ 0 + Condition.Exposure / (Block * VOT_gs) +
       (0 + Block * VOT_gs | ParticipantID) +
       (0 + Condition.Exposure / (Block * VOT_gs) | Item.MinimalPair),
     theta1 ~ 1),
   data = d_for_analysis %>%
     filter(Phase == "test") %>%
     prepVars(levels.Condition = levels_Condition.Exposure, contrast_type = "difference"),
   cores = 4,
   chains = chains,
   init = 0,
   iter = 4000, # if 1000 warmup then iter can be lowered to 2000
   warmup = 2000, # 1000 warmup will exceed max tree depth
   family = mixture(bernoulli("logit"), bernoulli("logit"), order = F),
   control = list(adapt_delta = .995),
   file ="../models/Exp-AE-DLVOT-nested-condition.rds")

# get tidy df of nested test simple effects within block --no divergence in model found
simple_effects_condition <- tidy(fit_mix_test_nested_block, effects = "fixed") %>% 
  filter(term != "theta1_(Intercept)") 

simple_effects_block <- tidy(fit_mix_test_nested_condition, effects = "fixed") %>% 
  filter(term != "theta1_(Intercept)")
```

```{r make-hypothesis-tables}
# hypotheses to answer question, "was the change incremental between blocks?"
hyp_interactions <- c(
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test2vs.Test1 < 0",
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test3vs.Test2 < 0",
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test4vs.Test3 < 0",
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test4vs.Test3 + mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test3vs.Test2 + mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test2vs.Test1 < 0",
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test2vs.Test1 < 0",
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test3vs.Test2 < 0",
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test4vs.Test3 < 0",
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test4vs.Test3 + mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test3vs.Test2 + mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test2vs.Test1 < 0"
)

# translate the hypotheses above into intelligible statements
hyp_interactions_readable <- tibble(Hypothesis = c(
  # Comparing differences in +10 vs baseline between blocks
  "Test block 2 > Test block 1", 
  "Test block 3  > Test block 2", 
  "Test block 4  > Test block 3", 
  "Test block 4  > Test block 1",  
  # Comparing differences in +40 vs +10 between blocks
  "Test block 2 > Test block 1", 
  "Test block 3  > Test block 2", 
  "Test block 4  > Test block 3", 
  "Test block 4  > Test block 1" 
))

hyp_interactions <- hypothesis(fit_mix_test, hyp_interactions)
hyp_interactions <- hyp_interactions$hypothesis %>% 
  select(-Star) 
table1 <- cbind(hyp_interactions_readable, hyp_interactions) %>% 
  select(-2) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))) %>% 
  rename_all(~ gsub("\\.", " ", .)) %>% 
  kbl(caption = "Was there incremental change from test blocks 1 to 4?", align = align_tab(table1)) %>% 
  kable_styling(full_width=FALSE, 
                bootstrap_options = c("striped", "hover", "condensed")) %>% 
  column_spec(1, width = "8em") %>% 
  pack_rows("Difference in +10 vs baseline", 1, 4) %>%
  pack_rows("Difference in +40 vs +10", 5, 8) 


# hypotheses to answer questions "when did change first emerge?" and "is the difference between groups proportional?"
hyp_contrasts_nested_block <- 
  c(
    "mu2_Block1:Condition.Exposure_Shift10vs.Shift0 < 0", 
    "mu2_Block1:Condition.Exposure_Shift40vs.Shift10 < 0", 
    "mu2_Block1:Condition.Exposure_Shift40vs.Shift10 + mu2_Block1:Condition.Exposure_Shift10vs.Shift0 < 0",
    "mu2_Block1:Condition.Exposure_Shift40vs.Shift10 < 3 * mu2_Block1:Condition.Exposure_Shift10vs.Shift0", # diff. between 40 and 10 is 3x 10 vs 0 
    
    "mu2_Block3:Condition.Exposure_Shift10vs.Shift0 < 0", 
    "mu2_Block3:Condition.Exposure_Shift40vs.Shift10 < 0", 
    "mu2_Block3:Condition.Exposure_Shift40vs.Shift10 + mu2_Block1:Condition.Exposure_Shift10vs.Shift0 < 0",
    "mu2_Block3:Condition.Exposure_Shift40vs.Shift10 < 3 * mu2_Block1:Condition.Exposure_Shift10vs.Shift0",
    
    "mu2_Block5:Condition.Exposure_Shift10vs.Shift0 < 0", 
    "mu2_Block5:Condition.Exposure_Shift40vs.Shift10 < 0", 
    "mu2_Block5:Condition.Exposure_Shift40vs.Shift10 + mu2_Block1:Condition.Exposure_Shift10vs.Shift0 < 0",
    "mu2_Block5:Condition.Exposure_Shift40vs.Shift10 < 3 * mu2_Block1:Condition.Exposure_Shift10vs.Shift0",
    
    "mu2_Block7:Condition.Exposure_Shift10vs.Shift0 < 0", 
    "mu2_Block7:Condition.Exposure_Shift40vs.Shift10 < 0", 
    "mu2_Block7:Condition.Exposure_Shift40vs.Shift10 + mu2_Block1:Condition.Exposure_Shift10vs.Shift0 < 0",
    "mu2_Block7:Condition.Exposure_Shift40vs.Shift10 < 3 * mu2_Block1:Condition.Exposure_Shift10vs.Shift0") # shift in 40vs 10 > 10 vs 0 within test 4

# translate hypotheses into intelligible statements
hyp_contrasts_nested_block_readable <- tibble(Hypothesis = c(
  "+10 vs baseline", 
  "+40 vs +10",
  "+40 vs baseline",
  "+40 vs baseline > 3x +10 vs baseline",
  
  "+10 vs baseline", 
  "+40 vs +10",
  "+40 vs baseline",
  "+40 vs baseline > 3x +10 vs baseline",
  
  "+10 vs baseline", 
  "+40 vs 10",
  "+40 vs baseline",
  "+40 vs baseline > 3x +10 vs baseline",
  
  "+10 vs baseline", 
  "+40 vs 10",
  "+40 vs baseline",
  "+40 vs baseline > 3x +10 vs baseline"
))

hyp_contrasts_nested_block <- hypothesis(fit_mix_test_nested_block, hyp_contrasts_nested_block)
hyp_contrasts_nested_block <- hyp_contrasts_nested_block$hypothesis %>% 
  select(-Star)

table2 <- cbind(hyp_contrasts_nested_block_readable, hyp_contrasts_nested_block) %>% 
  select(-2) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))) %>% 
  rename_all(~gsub("\\.", " ", .)) %>% 
  kbl(caption = "When did change emerge? Are differences proportional?", align = align_tab(table2)) %>% 
  kable_styling(full_width=FALSE, 
                bootstrap_options = c("striped", "hover", "condensed")) %>% 
  column_spec(1, width = "8em") %>% 
  pack_rows("Test block 1", 1, 4) %>%
  pack_rows("Test block 2", 5, 8) %>% 
  pack_rows("Test block 3", 9, 12) %>% 
  pack_rows("Test block 4", 13, 16) %>% 
  add_indent(c(4, 8, 12, 16))

# hypotheses to analyse last 3 test blocks (question: what happens with repeated testing)
hyp_test456 <- c(
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test5vs.Test4 < 0",
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test6vs.Test5 < 0",
  "mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test5vs.Test4 + mu2_Condition.Exposure_Shift10vs.Shift0:Block_Test6vs.Test5 < 0",
  
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test5vs.Test4 < 0",
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test6vs.Test5 < 0",
  "mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test5vs.Test4 + mu2_Condition.Exposure_Shift40vs.Shift10:Block_Test6vs.Test5 < 0"
)

# translate hypotheses into intelligible statements
hyp_test456_readable <- tibble(Hypothesis = c(
  # Comparing differences in +10 vs baseline between blocks 4 and 6
  "Test block 5 > Test block 4", 
  "Test block 6  > Test block 5", 
  "Test block 6  > Test block 4", 

  # Comparing differences in +40 vs +10 between blocks 4 and 6
  "Test block 5 > Test block 4", 
  "Test block 6  > Test block 5", 
  "Test block 6  > Test block 4"
))

hyp_test456 <- hypothesis(fit_mix_test, hyp_test456) 
hyp_test456 <- (hyp_test456$hypothesis) %>% 
  select(-Star) 

table3 <- cbind(hyp_test456_readable, hyp_test456) %>% 
  select(-2) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))) %>% 
  rename_all(~ gsub("\\.", " ", .)) %>% 
  kbl(caption = "Effects of repeated testing (test blocks 4 to 6)", align = align_tab(table2)) %>% 
  kable_styling(full_width=FALSE, 
                bootstrap_options = c("striped", "hover", "condensed"))%>% 
  column_spec(1, width = "8em") %>% 
  pack_rows("Difference in +10 vs baseline", 1, 3) %>%
  pack_rows("Difference in +40 vs +10", 4, 6) 
```


```{r print-hypotheses-tables}
table1
table2
table3
```






```{r getting-means-at-exposure-by-condition}
# calculate the various mean VOTs exposed to for each condition, including the labelled trials, with and without accounting for the test trials
cond_means_test_exposure <- d_for_analysis %>% 
  group_by(Condition.Exposure) %>% 
  summarise(across(c(Item.VOT, Item.Mel_F0_5ms), mean, .names = "{.col}_mean_test_exposure"))
  
cond_means_exposure <- d_for_analysis %>% 
  filter(Phase == "exposure") %>% 
  group_by(Condition.Exposure) %>% 
  summarise(across(c(Item.VOT, Item.Mel_F0_5ms), mean, .names = "{.col}_mean_exposure"))

cond_means <- left_join(cond_means_test_exposure, cond_means_exposure)
```


```{r non-parametric-density-plot, fig.width=6.5, fig.height=4.5}
# ensuring that a particular proportion of points are included within each contour line
# adjusted from https://stackoverflow.com/questions/75598144/interpretation-of-2d-density-estimate-charts
# we can get the 2d density with MASS::kde2d, then convert to a raster using terra. We can then order the points according to the density in the associated 2d density grid and find the density at which a quantile is passed with approx
d.chodroff_wilson <-
  get_ChodroffWilson_data(
    database_filename = "../data/all_observations_with_non-missing_vot_cog_f0.csv",
    min.n_per_talker_and_stop = 25,
    limits.VOT = c(-Inf, Inf),
    limits.f0 = c(0, 350),
    max.p_for_multimodality = .1
  ) %>%
  mutate_at(
    c("VOT", "f0_Mel"),
    list("centered" = function(x) apply_ccure(x, data = .)))

d.chodroff_wilson.selected <-
  d.chodroff_wilson %>%
  filter(poa == "/d/-/t/") %>%
  group_by(Talker, category) %>%
  mutate(n = n()) %>%
  group_by(Talker) %>%
  # subsample n tokens, as determined by category with fewer tokens
  mutate(
    n_min = min(n),
    n_category = n_distinct(category)) %>%
  # select talkers with both /d/ and /t/ observations
  filter(n_category == 2) %>%
  group_by(Talker, category) %>%
  sample_n(size = first(n_min)) %>%
  ungroup() %>%
  mutate_at(
      c("VOT", "f0", "f0_Mel", "f0_semitones"),
      list("centered" = function(x) apply_ccure(x, data = .))) %>% 
  mutate(category = factor(category))

quantile_levels <- c(0, .05, .25, .5, .75, .95, .99) 


p.density <- 
  d.chodroff_wilson.selected %>% 
  ggplot(aes(x = VOT_centered, y = f0_Mel_centered, linetype = category, group = category)) +
  geom_density2d(
    data = . %>% filter(category == "/d/"),
    contour_var = "density", aes(alpha = after_stat(level)), 
    colour = "black",
    breaks = density_quantiles(x = d.chodroff_wilson.selected %>% filter(category == "/d/") %>% pull(VOT_centered), 
                               y = d.chodroff_wilson.selected %>% filter(category == "/d/") %>% pull(f0_Mel_centered),
                               quantiles = quantile_levels[-1])) +
  geom_density2d(
    data = . %>% filter(category == "/t/"),
    contour_var = "density", aes(alpha = after_stat(level)), 
    colour = "black",
    breaks = density_quantiles(x = d.chodroff_wilson.selected %>% filter(category == "/t/") %>% pull(VOT_centered), 
                               y = d.chodroff_wilson.selected %>% filter(category == "/t/") %>% pull(f0_Mel_centered),
                               quantiles = quantile_levels[-1])) +
  scale_y_continuous("F0 (Mel)", limits = c(118, 360)) + 
  scale_x_continuous("VOT (ms)", limits = c(-12, 125), breaks = scales::breaks_width(25)) +
  scale_alpha_continuous(breaks = quantile_levels, range = c(.1, 1), labels = scales::percent(quantile_levels)) +
  theme(legend.position = "top") +
  #plot the uncentred means
  geom_point(
    data = d_for_analysis %>% 
      filter(Phase == "exposure") %>% 
      group_by(Condition.Exposure) %>%
      mutate(
        category = factor(ifelse(Item.ExpectedResponse.Voicing == "voiced", "/d/", "/t/"))) %>% 
      group_by(Condition.Exposure, category) %>% 
      summarise(across(c(Item.VOT, Item.Mel_F0_5ms), mean)),
    mapping = aes(x = Item.VOT, y = Item.Mel_F0_5ms, colour = Condition.Exposure, shape = category),
    size = 2,
    shape = c(1, 2, 1, 2, 1, 2),
    alpha = 0.8,
  inherit.aes = F) +
  #plot centred means
  geom_point(
    data = d_for_analysis %>% 
      filter(Phase == "exposure") %>% 
      group_by(Condition.Exposure) %>%
      mutate(
        category = factor(ifelse(Item.ExpectedResponse.Voicing == "voiced", "/d/", "/t/")),
        Item.VOT_centered = case_when(
          Condition.Exposure == "Shift0" ~ Item.VOT + (chodroff.mean_VOT - cond_means$Item.VOT_mean_test_exposure[1]),
          Condition.Exposure == "Shift10" ~ Item.VOT + (chodroff.mean_VOT - cond_means$Item.VOT_mean_test_exposure[2]),
          Condition.Exposure == "Shift40" ~ Item.VOT + (chodroff.mean_VOT - cond_means$Item.VOT_mean_test_exposure[3])),
        Item.Mel_F0_5ms_centered = case_when(
          Condition.Exposure == "Shift0" ~ Item.Mel_F0_5ms + (chodroff.mean_f0_Mel - cond_means$Item.Mel_F0_5ms_mean_exposure[1]),
          Condition.Exposure == "Shift10" ~ Item.Mel_F0_5ms + (chodroff.mean_f0_Mel - cond_means$Item.Mel_F0_5ms_mean_exposure[2]),
          Condition.Exposure == "Shift40" ~ Item.Mel_F0_5ms + (chodroff.mean_f0_Mel - cond_means$Item.Mel_F0_5ms_mean_exposure[3]))) %>% 
      group_by(Condition.Exposure, category) %>% 
      summarise(across(c(Item.VOT_centered, Item.Mel_F0_5ms_centered), mean)),
    mapping = aes(x = Item.VOT_centered, y = Item.Mel_F0_5ms_centered, colour = Condition.Exposure, shape = category),
    size = 2,
    alpha = 0.8,
  inherit.aes = F,
  show.legend = T) +
  scale_colour_manual("Condition",
             labels = c("+0ms", "+10ms", "+40ms"),
             values = c("#cc0000", "#12D432","#0481F3")) +
  guides(colour = "none",
         linetype = guide_legend(title = "Category"),
         shape = guide_legend(title = "Category")) + 
 theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) + 
  remove_axes_titles 
```



```{r plot-parametric-density-plot, warning=FALSE}
cov_d <- (d.chodroff_wilson.selected %>% 
  group_by(category) %>% 
  nest(data = -c(category)) %>% 
  mutate(covariance = map_dbl(data, ~ cov(.x$VOT_centered, .x$f0_Mel_centered))) %>% 
  pull(covariance))[1]

cov_t <- (d.chodroff_wilson.selected %>% 
  group_by(category) %>% 
  nest(data = -c(category)) %>% 
  mutate(covariance = map_dbl(data, ~ cov(.x$VOT_centered, .x$f0_Mel_centered))) %>% 
  pull(covariance))[2]

cat_d <- d.chodroff_wilson.selected %>% 
  filter(category == "/d/")

cues <- c("VOT", "f0_Mel")

d.category_ellipse <- d.chodroff_wilson.selected %>% 
  group_by(category) %>% 
  summarise(across(c(VOT_centered, f0_Mel_centered), list(mean = mean, var = var), .names = "{.col}.{.fn}")) %>% 
  mutate(cov = ifelse(category == "/d/", cov_d, cov_t),
         mu = map2(VOT_centered.mean, f0_Mel_centered.mean, ~ c("VOT" = .x, "f0_Mel" = .y)),
         Sigma = pmap(list(VOT_centered.var, f0_Mel_centered.var, cov), ~ matrix(c(..1, ..3, ..3, ..2), 2, 2, dimnames = list(cues, cues)))) %>% 
  select(c(category, mu, Sigma)) %>% 
  crossing(level = quantile_levels) %>% 
  group_by(category) %>%
  mutate(ellipse = c(1:length(quantile_levels)),
         ellipse_points = pmap(list(mu, Sigma, level), ~ get_bivariate_normal_ellipse(mu = ..1, Sigma = ..2, level = ..3))) %>% 
  group_by(ellipse) %>% 
  mutate(path = pmap(list(category, level, ellipse_points),
                     ~ geom_path(data = ..3, mapping = aes(x = ..3[[1]], y = ..3[[2]], linetype = ..1, colour = ..2))))

p.ellipse <- d.category_ellipse %>% 
  ggplot() +
  d.category_ellipse$path +
  scale_y_continuous("F0 (Mel)", limits = c(118, 360)) +
  scale_x_continuous("VOT (ms)", limits = c(-12, 125), breaks = scales::breaks_width(25)) +
  scale_color_gradient("Interval", low = "#000000",
  high = "#D0D0D0") +
  # scale_linetype_manual("Category", values = c(1, 2)) + 
  # theme(legend.position = "right") +
  new_scale_color() +
  #plot the uncentred means
  geom_point(
    data = d_for_analysis %>% 
      filter(Phase == "exposure") %>% 
      group_by(Condition.Exposure) %>%
      mutate(
        category = factor(ifelse(Item.ExpectedResponse.Voicing == "voiced", "/d/", "/t/"))) %>% 
      group_by(Condition.Exposure, category) %>% 
      summarise(across(c(Item.VOT, Item.Mel_F0_5ms), mean)),
    mapping = aes(x = Item.VOT, y = Item.Mel_F0_5ms, colour = Condition.Exposure, shape = category),
    size = 2,
    shape = c(1, 2, 1, 2, 1, 2),
    alpha = 0.8,
  inherit.aes = F,
  show.legend = F) +
  scale_colour_manual("Condition",
             labels = c("+0ms", "+10ms", "+40ms"),
             values = c("#cc0000", "#12D432","#0481F3")) +
  #plot the centered means
  geom_point(
    data = d_for_analysis %>% 
      filter(Phase == "exposure") %>% 
      group_by(Condition.Exposure) %>%
      mutate(
        category = factor(ifelse(Item.ExpectedResponse.Voicing == "voiced", "/d/", "/t/")),
        Item.VOT_centered = case_when(
          Condition.Exposure == "Shift0" ~ Item.VOT + (chodroff.mean_VOT - cond_means$Item.VOT_mean_test_exposure[1]),
          Condition.Exposure == "Shift10" ~ Item.VOT + (chodroff.mean_VOT - cond_means$Item.VOT_mean_test_exposure[2]),
          Condition.Exposure == "Shift40" ~ Item.VOT + (chodroff.mean_VOT - cond_means$Item.VOT_mean_test_exposure[3])),
        Item.Mel_F0_5ms_centered = case_when(
          Condition.Exposure == "Shift0" ~ Item.Mel_F0_5ms + (chodroff.mean_f0_Mel - cond_means$Item.Mel_F0_5ms_mean_test_exposure[1]),
          Condition.Exposure == "Shift10" ~ Item.Mel_F0_5ms + (chodroff.mean_f0_Mel - cond_means$Item.Mel_F0_5ms_mean_test_exposure[2]),
          Condition.Exposure == "Shift40" ~ Item.Mel_F0_5ms + (chodroff.mean_f0_Mel - cond_means$Item.Mel_F0_5ms_mean_test_exposure[3]))) %>% 
      group_by(Condition.Exposure, category) %>% 
      summarise(across(c(Item.VOT_centered, Item.Mel_F0_5ms_centered), mean)),
    mapping = aes(x = Item.VOT_centered, y = Item.Mel_F0_5ms_centered, colour = Condition.Exposure, shape = category),
    size = 2,
    alpha = 0.8,
  inherit.aes = F,
  show.legend = F) +
  guides(linetype = "none")
  # scale_colour_manual("Condition",
  #            labels = c("+0ms", "+10ms", "+40ms"),
  #            values = c("#cc0000", "#12D432","#0481F3")) +
```


```{r exposure-means-database-density, fig.width= 6, fig.height=4, warning=FALSE}
(p.density / p.ellipse) +
  plot_layout(ncol = 1, guides = "collect") &
  theme(legend.position = "right")
```




